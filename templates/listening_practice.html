<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ content.title }} - Listening Practice</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/gamified.css') }}">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body class="bg-gradient">
    <div class="container-fluid py-4">
        <!-- Header -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="game-card">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <h2><i class="fas fa-headphones me-2" style="color: var(--listening-color);"></i>{{ content.title }}</h2>
                            <p class="mb-0">Listen carefully and type what you hear!</p>
                        </div>
                        <div class="col-md-4 text-end">
                            <a href="{{ url_for('listening_module') }}" class="btn btn-outline-primary">
                                <i class="fas fa-arrow-left me-2"></i>Back to Listening
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Robot Character -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="module-card listening text-center">
                    <div class="robot-character" id="robotCharacter">
                        {% if content.robot_character == 'boy' %}ü§ñ{% else %}ü§ñ{% endif %}
                    </div>
                    <h4>{{ content.robot_character.title() }} Robot</h4>
                    <p class="text-muted">Hi! I'm going to speak to you. Listen carefully and type exactly what I say!</p>
                    
                    <!-- Hidden audio element for playback -->
                    <audio id="practiceAudio" preload="auto" src="{{ url_for('static', filename='audio/' + content.audio_file) }}"></audio>

                    <button class="btn btn-listening btn-lg" id="playAudioBtn" onclick="playRobotAudio()">
                        <i class="fas fa-play me-2"></i>Play Audio
                    </button>
                </div>
            </div>
        </div>

        <!-- Listening Form -->
        <div class="row">
            <div class="col-12">
                <div class="game-card">
                    <h5><i class="fas fa-keyboard me-2"></i>Type What You Heard</h5>
                    
                    <form id="listeningForm" method="POST" action="{{ url_for('submit_listening') }}">
                        <input type="hidden" name="content_id" value="{{ content.id }}">
                        
                        <div class="mb-4">
                            <label for="user_input" class="form-label">Your Answer:</label>
                            <textarea class="form-control game-input no-copy" 
                                      id="user_input" 
                                      name="user_input" 
                                      rows="6" 
                                      placeholder="Type exactly what the robot said..."
                                      required
                                      disabled></textarea>
                            <small class="text-muted">üí° Play the audio first, then type what you heard</small>
                        </div>
                        
                        <div class="text-center">
                            <button type="submit" class="btn btn-game-primary btn-lg" id="submitBtn" disabled>
                                <i class="fas fa-check me-2"></i>Submit Answer
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Instructions -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="game-card">
                    <h6><i class="fas fa-lightbulb me-2"></i>Listening Tips</h6>
                    <ul class="mb-0">
                        <li>üéß Listen to the complete audio before typing</li>
                        <li>üìù Type exactly what you hear - every word matters!</li>
                        <li>üîÅ You can replay the audio multiple times</li>
                        <li>‚úÖ Perfect match = 10 points, good attempt = 5 points</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{{ url_for('static', filename='js/gamified.js') }}"></script>
    
    <script>
        let audioPlayed = false;

        function playRobotAudio() {
            const robot = document.getElementById('robotCharacter');
            const playBtn = document.getElementById('playAudioBtn');
            const textArea = document.getElementById('user_input');
            const submitBtn = document.getElementById('submitBtn');
            const audio = document.getElementById('practiceAudio');

            if (!audio) {
                showFlashMessage('Audio file missing. Please contact admin.', 'error');
                return;
            }

            // Reset and play
            audio.currentTime = 0;
            audio.play().then(() => {
                // Animate robot speaking while audio plays
                animateRobot('speak');
                robot.style.background = 'linear-gradient(135deg, #3498db 0%, #2980b9 100%)';
                robot.style.animation = 'robotSpeak 0.5s ease-in-out infinite';
                playBtn.innerHTML = '<i class="fas fa-volume-up me-2"></i>Playing...';
                playBtn.disabled = true;
            }).catch(() => {
                showFlashMessage('Unable to play audio. Check browser permissions.', 'warning');
            });

            // When audio ends, enable typing
            audio.onended = () => {
                robot.style.animation = 'robotBob 2s ease-in-out infinite';
                robot.style.background = 'var(--primary-gradient)';
                playBtn.innerHTML = '<i class="fas fa-redo me-2"></i>Play Again';
                playBtn.disabled = false;
                textArea.disabled = false;
                submitBtn.disabled = false;
                textArea.focus();
                showFlashMessage('‚úÖ Audio finished! Now type what you heard in the text area.', 'success');
                audioPlayed = true;
            };
        }

        // Handle form submission
        document.getElementById('listeningForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            if (!audioPlayed) {
                showFlashMessage('Please play and listen to the audio first!', 'warning');
                return;
            }
            
            const submitBtn = document.getElementById('submitBtn');
            const originalText = submitBtn.innerHTML;
            
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Checking Answer...';
            submitBtn.disabled = true;
            
            const formData = new FormData(this);
            
            fetch('{{ url_for("submit_listening") }}', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
                
                if (data.celebration) {
                    // Perfect match celebration
                    triggerCelebration(data.points);
                    showFlashMessage(`üéâ Perfect! You got it exactly right! Points earned: ${data.points}`, 'success');
                } else {
                    // Good attempt
                    showFlashMessage(`Good try! Accuracy: ${data.accuracy}% | Points earned: ${data.points}`, 'info');
                }
                
                setTimeout(() => {
                    window.location.href = '{{ url_for("listening_module") }}';
                }, 3000);
            })
            .catch(error => {
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
                showFlashMessage('Error submitting answer. Please try again.', 'error');
            });
        });
    </script>
</body>
</html>