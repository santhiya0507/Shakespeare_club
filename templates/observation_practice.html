<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ content.title }} - Observation Practice</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/gamified.css') }}">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body class="bg-gradient">
    <div class="container-fluid py-4">
        <!-- Header -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="game-card">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <h2><i class="fas fa-eye me-2" style="color: var(--observation-color);"></i>{{ content.title }}</h2>
                            <p class="mb-0">Watch carefully and answer the questions!</p>
                        </div>
                        <div class="col-md-4 text-end">
                            <a href="{{ url_for('observation_module') }}" class="btn btn-outline-primary">
                                <i class="fas fa-arrow-left me-2"></i>Back to Observation
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Video Section -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="module-card observation">
                    <h5><i class="fas fa-video me-2"></i>Motivational Video</h5>
                    
                    <div class="video-container text-center mb-4">
                        <div class="ratio ratio-16x9">
                            <iframe id="ytFrame"
                                    src=""
                                    title="{{ content.title }}"
                                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                                    allowfullscreen
                                    referrerpolicy="strict-origin-when-cross-origin"></iframe>
                        </div>
                        <small class="text-muted d-block mt-2">Source: {{ content.video_url }}</small>
                    </div>
                    
                    <div class="alert alert-info">
                        <h6><i class="fas fa-lightbulb me-2"></i>Observation Tips</h6>
                        <ul class="mb-0">
                            <li>üëÄ Watch the entire video carefully</li>
                            <li>üìù Pay attention to key messages and themes</li>
                            <li>üß† Think about the main points being communicated</li>
                            <li>üí° Consider how the content relates to motivation and success</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Questions Section -->
        <div class="row">
            <div class="col-12">
                <div class="game-card">
                    <h5><i class="fas fa-question-circle me-2"></i>Comprehension Questions</h5>
                    
                    <form id="observationForm" method="POST" action="{{ url_for('submit_observation') }}">
                        <input type="hidden" name="content_id" value="{{ content.id }}">
                        
                        <div class="mb-4">
                            <label for="user_answer" class="form-label">
                                <strong>Question:</strong> {{ content.questions }}
                            </label>
                            <textarea class="form-control game-input no-copy" 
                                      id="user_answer" 
                                      name="user_answer" 
                                      rows="6" 
                                      placeholder="Provide your detailed answer here..."
                                      required></textarea>
                            <small class="text-muted">üí° Watch the video and reflect before answering</small>
                        </div>
                        
                        <div class="text-center">
                            <button type="submit" class="btn btn-game-primary btn-lg" id="submitBtn">
                                <i class="fas fa-check me-2"></i>Submit Answer
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Video Watched Indicator -->
        <div class="row mt-4" id="videoWatchedIndicator" style="display: none;">
            <div class="col-12">
                <div class="game-card text-center">
                    <i class="fas fa-check-circle fa-3x mb-3" style="color: var(--observation-color);"></i>
                    <h5>Video Watched Successfully!</h5>
                    <p>Now answer the questions above to complete your observation practice.</p>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{{ url_for('static', filename='js/gamified.js') }}"></script>
    <script>
        // Build YouTube embed URL from various URL formats
        function toYouTubeEmbed(url) {
            try {
                const u = new URL(url);
                if (u.hostname.includes('youtube.com')) {
                    if (u.pathname === '/watch') {
                        const v = u.searchParams.get('v');
                        if (v) return `https://www.youtube.com/embed/${v}`;
                    }
                    if (u.pathname.startsWith('/embed/')) {
                        return url; // already embed
                    }
                    if (u.pathname.startsWith('/shorts/')) {
                        const id = u.pathname.split('/')[2];
                        if (id) return `https://www.youtube.com/embed/${id}`;
                    }
                }
                if (u.hostname === 'youtu.be') {
                    const id = u.pathname.replace('/', '');
                    if (id) return `https://www.youtube.com/embed/${id}`;
                }
            } catch (e) {}
            return url; // fallback
        }

        (function initVideo() {
            const src = toYouTubeEmbed(`{{ content.video_url }}`);
            const frame = document.getElementById('ytFrame');
            if (frame) frame.src = src;
        })();

        // Handle form submission via fetch to preserve existing UX
        document.getElementById('observationForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const submitBtn = document.getElementById('submitBtn');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Analyzing Answer...';
            submitBtn.disabled = true;
            const formData = new FormData(this);
            fetch('{{ url_for("submit_observation") }}', { method: 'POST', body: formData })
                .then(r => r.json())
                .then(data => {
                    submitBtn.innerHTML = originalText;
                    submitBtn.disabled = false;
                    if (data.celebration) {
                        triggerCelebration(data.points);
                        showFlashMessage(`üéâ Excellent observation! Perfect answer! Points earned: ${data.points}`, 'success');
                    } else {
                        showFlashMessage(`Good observation! Accuracy: ${data.accuracy}% | Points earned: ${data.points}`, 'info');
                    }
                    setTimeout(() => { window.location.href = '{{ url_for("observation_module") }}'; }, 3000);
                })
                .catch(() => {
                    submitBtn.innerHTML = originalText;
                    submitBtn.disabled = false;
                    showFlashMessage('Error submitting answer. Please try again.', 'error');
                });
        });
    </script>
</body>
</html>